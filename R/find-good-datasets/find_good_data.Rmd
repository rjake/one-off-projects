---
title: "Find Datasets"
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    source_code: embed
    theme: lumen
    navbar:
    - icon: fa-github
      href: https://github.com/rjake/one-off-projects/blob/main/R/find-good-datasets
      align: right
resource_files:
- ds_list.Rds
- data_details.csv
---

```{r input-demo, eval=interactive()}
library(shiny)
library(shinyobjects)
options("shiny.suppressMissingContextError" = TRUE)

input <-
  list(
    # from JS
    arrow_left = TRUE,
    arrow_right = TRUE,
    # from widgets
    back = TRUE,
    forward = TRUE,
    pkg = "carData",
    category = "data.frame",
    selected = "carData::Arrests"
  )

```

```{css css-style}
.section.sidebar {
  overflow-x: hidden;
  overflow-y: scroll;
}

.bttn-gradient.bttn-primary, .bttn-simple.bttn-primary {
  background: #999;
}

.btn {
  text-transform: initial;
}
```

```{r workspace}
library(flexdashboard)
library(datasets)
library(tidyverse)
library(shinyWidgets)
library(reactable)
library(glue)


# * ds_obj ----
ds_obj <- read_rds("ds_list.Rds")

# * ds_info ----
ds_info <- 
  read_csv("data_details.csv") |> 
  mutate(pkg = ifelse(pkg == "datasets", "base", pkg)) |> 
  arrange(pkg, name)

# * starting_data ----
starting_data <- local({
  df <- 
    ds_info |> 
    filter(pkg == "base", category == "data.frame")
  
  available <- df |> pull(pkg_data)
  
  list(
    pkg = df$pkg[1],
    available = available,
    data = available[1]
  )
})
  
```


```{js js-code}
// https://stackoverflow.com/questions/56600232/detecting-arrow-key-cursor-key-in-shiny

$(document).on('keydown', function(event){
    var key = event.which;
    if(key === 37){
        Shiny.setInputValue('arrow_left', true, {priority: 'event'});
    } else if(key === 39){
      Shiny.setInputValue('arrow_right', true, {priority: 'event'});
    }
});
```


```{r custom-fns}
display <- function(x) {
  set_names(
    x = x,
    nm = str_remove(x, ".*:")
  )
}

log_rv <- function() {
  cat(
    # "id = ", rv$id,
    # "\n choices = ", head(rv$available),
    # "\n selected = ", rv$data,
    "\n pkg = ", input$pkg,
    "\n type = ", input$type,
    "\n \n"
  )
}


iprint <- function(x, n = 15) {
  if (interactive()) {
    print(x, n = n)
  } else {
    return(x)
  }
}

vec_to_button <- function(inputId, vec, ...) {
  x <- table(vec)
  
  choices <-
    set_names(
      x = names(x),
      nm = glue("{names(x)} ({x})")
    )
  
  radioGroupButtons( 
    inputId = inputId,
    label = NULL,
    ...,
    size = "xs",
    choices = 
      list(any = "any") |> 
      append(choices)
  )
}


arrow <- function(id, dir) {
  actionBttn(
    inputId = id,
    label = NULL,
    style = "simple",
    color = "primary",
    size = "xs",
    icon = icon(
      name = paste0("long-arrow-alt-", dir)#, style = "color:black;"
    )
  )
}


custom_DT <- function(data, ...) {
  DT::datatable(
    data,
    filter = "top",
    escape = FALSE,
    options =
      list(
        ...,
        dom = "Brti",
        deferRender = FALSE,
        scrollY = 350,
        scrollX = TRUE,
        fixedHeader = FALSE,
        pageLength = nrow(data),
        lengthChange = FALSE
      )
  )
}

```



Sidebar {.sidebar data-width=470}
================================================================================

### {data-height=40}

```{r reactive-data}
listen_pkg <- reactive({
  if (input$pkg == "any") {
    seq_along(ds_info$pkg)
  } else {
    which(ds_info$pkg == input$pkg)
  } 
})

listen_category <- reactive({
  if (input$category == "any") {
    seq_along(ds_info$category)
  } else {
    which(ds_info$category == input$category)
  } 
})

listen_possible <- reactive({
  intersect(listen_pkg(), listen_category())
})
```


```{r input-pkg}
vec_to_button(
  inputId = "pkg",
  vec = ds_info$pkg,
  selected = starting_data$pkg
) 

```

### {data-height=40}

```{r input-category}
renderUI({
  vec_to_button(
    inputId = "category",
    vec = ds_info$category[listen_pkg()],
    selected = min(ds_info$category[listen_pkg()])
  )
})

```

###
```{r input-arrows}
renderUI({
 glue(
   "Browse data sets ({n})",
   n = length(listen_possible())
  ) |> 
    h5()
  
})

shiny::fluidRow(
  arrow("back",    "left"),
  arrow("forward", "right"),
  a("or use arrow keys", style = "color:#999;"),
  style = "margin-left: 0px; margin-bottom: 10px"
)


observeEvent(list(input$back, input$arrow_left), {
  req(input$selected)
  id_names <- ds_info$pkg_data[listen_possible()]
  get_id <- which(id_names == input$selected)
  new_id <- max(get_id - 1, 1)

  updateRadioGroupButtons(
    session,
    inputId = "selected",
    size = "sm",
    selected = id_names[new_id]
  )
})

observeEvent(list(input$forward, input$arrow_right), {
  req(input$selected)

  id_names <- ds_info$pkg_data[listen_possible()]
  get_id <- which(id_names == input$selected)
  new_id <- min(get_id + 1, length(id_names))

  updateRadioGroupButtons(
    session,
    inputId = "selected",
    size = "sm",
    selected = id_names[new_id]
  )
})


```

```{r input-selected}
# TODO: can color be adjusted by data type?
# https://github.com/dreamRs/shinyWidgets/issues/70
# https://github.com/dreamRs/shinyWidgets/issues/41
# 
renderUI({
  ids <- listen_possible()
  
  radioGroupButtons(
    inputId = "selected",
    label = NULL,
    size = "xs",
    choices = display(ds_info$pkg_data[ids]),
    selected = ds_info$pkg_data[ids][1] #rv$available[1]
  )
})

```


Preview
================================================================================

Column
-----------------------------------------------------------------------

### {data-height=50}
```{r data-info}
renderUI({
  #print(input$selected)
  ds_info |> 
    filter(pkg_data == input$selected) |>
    mutate(
      dim = replace_na(dim, ""),
      cat_addl = ifelse(class != category, glue(" ({category})"), ""),
      dim_addl = ifelse(is_df & is_trunc, " (truncated for display)", "")
    ) |> 
    glue::glue_data(
      "{strong(pkg_data)} - {title}\\
      <br/> {{{class}}}{cat_addl} {dim}{dim_addl}
      <br/>"
    ) |>
    paste(
      actionLink(
        inputId = "meta",
        label = "see metadata",
        style = "color:dodgerblue;",
        onclick = "location.href='#section-metadata';"
      )
    ) |> 
    HTML()
})


```

### 

```{r output-table}
# https://stackoverflow.com/questions/41381466/can-we-either-print-or-plot-in-shiny-in-same-panel
output$table <- renderReactable({
  x <- ds_obj[[input$selected]]$data
  reactable(x, filterable = TRUE, pagination = FALSE)
})

output$print <- renderPrint({
  ds_obj[[input$selected]]$data
})

output$final_display <- renderUI({
  x <- ds_obj[[input$selected]]$data
  # print(x)
  # print(is.data.frame(x))
  if (is.data.frame(x)) {
    reactable::reactableOutput("table")
  } else {
    verbatimTextOutput("print")
  }
})

uiOutput("final_display")
  
# output$final_display <- renderPrint({
#   #log_rv()
#   print(ds_obj[[input$selected]]$data)
# })
# 
# verbatimTextOutput("final_display")

```


Metadata
=====================================     
   
Column
-------------------------------------

### {data-height=30}

```{r back-arrow}
actionButton(
  inputId = "back",
  label = "Back",
  icon = icon(name = "long-arrow-alt-left"),
  style = "color:dodgerblue;",
  onclick = "location.href='#section-preview';"
)

```

### 
```{r metadata, eval=!FALSE}

### 
renderReactable({
  ids <- listen_possible()
  
  ds_info |> 
    slice(ids) |> 
    select(
      title,
      name, pkg, class,
      n_discrete, n_numeric, n_date,
      #dim,
      n_row, n_col
    ) |> 
    arrange(name) |> 
    mutate(across(where(is.character), as.factor)) |> 
    reactable::reactable(
      filterable = TRUE, pagination = FALSE,
      columns = list(
        title = colDef(width = 300, style = list(backgroundColor = "#f7f7f7")),
        name = colDef(width = 100, style = list(fontWeight = "bold"))
      )
    )
})
  # custom_DT(
  #   autoWidth = TRUE,
  #   columnDefs = list(
  #       list(targets = c(1), visible = TRUE, width = "200px")
  #     )
  # )
```

